import e from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import r from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import o from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import t from"../../../call/index.js";import s from"../../../token.js";import{IAPPayType as n,ProrationMode as a}from"../../../../types/enum.js";import{apiResponse as d}from"../../../../utils/response.js";import{PAYMENT_APIS as p,APP_ID as i,PRORATION_MODE as c}from"../../../../constants.js";import{__generator as l}from'./../../../../external/tslib/tslib.es6.js';import m from"../../../../appEnv/getEnv.js";var u,f=(u=e((function(e,u,f,_,E){var h,I,j,R,A,w,v,P,T,D,y,b,C,S;return l(this,(function(l){switch(l.label){case 0:A=i,(w=new URLSearchParams).append("payType",u||n.SUBSCRIPTION),v=a.UNKNOW,f===c.IMMEDIATE_AND_CHARGE_FULL_PRICE&&(v=a.IMMEDIATE_AND_CHARGE_FULL_PRICE),f===c.DEFERRED&&(v=a.DEFERRED),w.append("utm",E||"default"),w.append("prorationMode",v.toString()),w.append("appId",A),_&&w.append("method",_),P="",(null===(h=m())||void 0===h||null===(I=h.platform)||void 0===I?void 0:I.isIOS)?P="ios":(null===(j=m())||void 0===j||null===(R=j.platform)||void 0===R?void 0:R.isAndroid)&&(P="android"),w.append("os",P),w.append("productId",e),T={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},l.label=1;case 1:return l.trys.push([1,5,,6]),[4,s.getAccessToken().catch((function(){throw d.error.loginRequired}))];case 2:return D=l.sent(),T.headers.authorization="Bearer ".concat(D),[4,fetch(p.CREATE_IAP_ORDER,o(r({method:"POST"},T),{body:w}))];case 3:return[4,l.sent().json()];case 4:if(!(y=l.sent()).data||!y.data.store||0!==y.err)throw d.error.createIAPOrderFailed(y.err);return b=y.data.store,C=y.data.orderId,[2,new Promise((function(e,o){t("IAP_REQUESTPAYMENT",r({},b),{success:function(){e({orderId:C})},fail:function(e){o(e)}})}))];case 5:throw S=l.sent(),console.log("Internal error"),S;case 6:return[2]}}))})),function(e,r,o,t,s){return u.apply(this,arguments)});export{f as default};
