import o from'./../../external/@swc/helpers/src/_async_to_generator.mjs.js';import{RESPONSE_CODE as e,MESSAGES as a}from"../../constants.js";import t from"../../utils/lodash.js";import{MPEEmitter as r,onActionMessage as i,fireActionMessage as l}from"../eventEmitter.js";import{parseJSON as n,getDynamicAPIByAction as s,checkIOSSupportAction as c,serialize as u,isRequireUserAuthentication as d}from"../../utils/common.js";import m from"../token.js";import{sendLogData as v}from"../utils.js";import p from"../apis/general/getSetting.js";import f from"../../appEnv/getEnv.js";import{__generator as _}from'./../../external/tslib/tslib.es6.js';import{Events as g}from"../../types/enum.js";var h,I,b,T,M,j,E=(b=f(),T={},M=r.getInstance(),j=[],!1||(i((function(o){var e=o.serialId,a=n(o.result),r=s(null==a?void 0:a.action),i=t.isEmpty(null==a?void 0:a.error_code)?0:null==a?void 0:a.error_code,l=null==a?void 0:a.error_message,c=(null==a?void 0:a.data)||a;if(r&&0===i){var u=JSON.parse(null==a?void 0:a.data);i=t.isEmpty(null==u?void 0:u.error_code)?0:null==u?void 0:u.error_code,l=null==u?void 0:u.error_message,c=(null==u?void 0:u.data)||u}var d={error_code:i,error_message:l,data:c,action:(null==a?void 0:a.action)||o.actionName};if(e&&T[e]){var m=T[e],v=m.callback,p=m.timeout,f=m.isMultiCallback,_=m.options;!function(o,e){var a=e||{},r=a.success,i=a.fail;0===o.error_code?t.isFunction(r)&&r(o):t.isFunction(i)&&i(o)}(d,v),!f&&delete T[e],p&&clearTimeout(p);var g={action:null==d?void 0:d.action,error:null==d?void 0:d.error_code,message:null==d?void 0:d.error_message,data:{}};try{if("action.open.inapp"===d.action||"action.open.outapp"===d.action){var h=new URL(null==_?void 0:_.url),I="".concat(h.protocol,"//").concat(h.host).concat(h.pathname);g.data={url:I}}if("action.follow.oa"===d.action||"action.unfollow.oa"===d.action){var b=null==_?void 0:_.uid;g.data={uid:b}}if("action.open.chat"===d.action){var M=null==_?void 0:_.uId,E=null==_?void 0:_.type;g.data={uid:M,openChatType:E}}}catch(o){}j.push(g)}})),M.on(g.AppPaused,(function(){if(j.length>0){var o=j;j=[],v(o)}})),h?clearInterval(h):h=setInterval((function(){if(j.length>0){var o=j;j=[],v(o)}}),5e3),!0),I=o((function(o,r,i,n){var v,f,g,h,I,M,j,E,N,S,k,w,O,U,y,C,A,J,P,R,L,Z,D,F,H;return _(this,(function(_){switch(_.label){case 0:return f=Math.floor(1e6*Math.random()),g="".concat(o,"_").concat(f),h="action.".concat(o.replace(/\_/g,".").toLowerCase()),(null==n?void 0:n.actionName)&&n.actionName.length>0&&(h=null==n?void 0:n.actionName),I=(null==n?void 0:n.isMultiCallback)||!1,M=!1!==(null==n?void 0:n.timeout)&&((null==n?void 0:n.timeout)||!0),j=(null==n?void 0:n.haveActionCallback)||!1,E=(null==n?void 0:n.skipJump)||!1,N=(null==n?void 0:n.requireAccessToken)||!1,S=d(h),r&&i&&(T[g]={options:r,callback:i,isMultiCallback:I},M&&j&&(T[g].timeout=setTimeout((function(){var t={serialId:g,result:{error_code:e.TIME_OUT,error_message:a.TIME_OUT,data:{timeout:M},action:o}};return l(t),null}),!0===M?8e3:1e3*M))),S?[4,p()]:[3,2];case 1:if(!1===(null==(w=_.sent())||null===(k=w.authSetting)||void 0===k?void 0:k["scope.userInfo"]))return U={serialId:g,result:{error_code:e.UNAUTHORIZED,error_message:a.NEED_USER_AUTH,data:{isMobile:null==b||null===(O=b.platform)||void 0===O?void 0:O.isMobile},action:o}},l(U),[2];_.label=2;case 2:return y=s(h),!(null==b||null===(v=b.platform)||void 0===v?void 0:v.isMobile)||!o||t.isUndefined(ZaloJavaScriptInterface)||b.platform.isIOS&&!c(o)||y&&!1===y.isSupported?(A={serialId:g,result:{error_code:e.CLIENT_NOT_SUPPORT,error_message:a.CLIENT_NOT_SUPPORT,data:{isMobile:null==b||null===(C=b.platform)||void 0===C?void 0:C.isMobile},action:o}},l(A),[2]):(J=u(r),E?[3,4]:[4,m.getJSAccessToken()]);case 3:return R=_.sent(),[3,5];case 4:R="",_.label=5;case 5:P=R,_.label=6;case 6:return _.trys.push([6,10,,11]),E||!N?[3,8]:[4,m.getAccessToken()];case 7:return Z=_.sent(),[3,9];case 8:Z="",_.label=9;case 9:return L=Z,[3,11];case 10:return D=_.sent(),F={serialId:g,result:{error_code:null==D?void 0:D.code,error_message:null==D?void 0:D.message,action:o}},l(F),[2];case 11:return H=b.platform.isIOS?window.onNativeMessage(g,h):'window.onNativeMessage("'.concat(g,'", "').concat(h,'")'),[2,ZaloJavaScriptInterface.jsCall(P,h,L,J,H)]}}))})),function(o,e,a,t){return I.apply(this,arguments)});export{E as default};
