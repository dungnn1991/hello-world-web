import e from'./../external/@swc/helpers/src/_async_to_generator.mjs.js';import n from'./../external/@swc/helpers/src/_class_call_check.mjs.js';import t from'./../external/@swc/helpers/src/_create_class.mjs.js';import s from'./../external/@swc/helpers/src/_object_spread.mjs.js';import o from"../utils/lodash.js";import{COOKIE_NAME as r,APIS as i,APP_ID as c,ZAPP_ID as a,ApiCallStage as u,MINI_APP_INTERNAL_LINK as l}from"../constants.js";import{logger as m}from"./logger.js";import p from"./call/zaloNative.js";import{apiResponse as f}from"../utils/response.js";import{sendLogData as d}from"./utils.js";import{getDynamicAPIByAction as h}from"../utils/common.js";import{__generator as g}from'./../external/tslib/tslib.es6.js';import{JumpStatus as _}from"../types/enum.js";import{authorize as T}from"../apis/authorize.js";import{getSetting as k}from"../apis/getSetting.js";var v=function(){function v(){n(this,v),this._jumpStatus=void 0,this.WAITING_QUEUE=[],this.getAccessTokenCount=0,this._accessToken="",this._jsAccessToken="",this.refreshToken="",this._cookies=[],this.accessTokenExpiresIn=0,this.prevGetAccessTokenTimestamp=(new Date).getTime(),this.manualSetAccessToken=!1,this._miniProgramConfig={}}var A=v.prototype;return A.jump=function(){var n=this;return e((function(){return g(this,(function(e){return[2,new Promise((function(e,t){n._jumpStatus?n._jumpStatus===_.DONE?e(_.DONE):e(_.DOING):(n._jumpStatus=_.DOING,m({stage:u.REQUEST,type:"log",name:"jump"}),p("JUMP_LOGIN",{},{success:function(t){var s=t.data;n._miniProgramConfig=(null==s?void 0:s.miniProgramConfig)||{};var o=(null==s?void 0:s.cookiesOAuthLogins)||[],i=o.find((function(e){return e.name===r.JS_TOKEN}));i&&(n._jsAccessToken=i.value,window.ZJSBridge.setJSToken&&window.ZJSBridge.setJSToken(i.value)),n._cookies=o;var c=n._cookies.find((function(e){return e.name===r.ZOAUTH}));(null==c?void 0:c.value)||d([{action:"action.jump.login",error:-102,message:"no zoauth",data:{}}]),e(_.DONE)},fail:function(e){d([{action:"action.jump.login",error:-101,message:e.message||"jump error",data:{}}]),t(e)}},{skipJump:!0}))}))]}))}))()},A.loginZaloV3=function(n,t,s){var o=this;return e((function(){var r;return g(this,(function(c){switch(c.label){case 0:return r="".concat(i.GET_ACCESS_TOKEN_V3,"?app_id=").concat(t,"&redirect_uri=").concat(l,"/").concat(n,"/&code=").concat(s,"&isSDK=true"),[4,fetch(r).then((a=e((function(e){var n,t,s;return g(this,(function(r){switch(r.label){case 0:return[4,e.json()];case 1:return n=r.sent(),t=null==n?void 0:n.access_token,o._accessToken=t,s=1e3*parseInt(n.expires_in),o.accessTokenExpiresIn=s,o.prevGetAccessTokenTimestamp=(new Date).getTime(),window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(o._accessToken||""),[2,t]}}))})),function(e){return a.apply(this,arguments)}))];case 1:return[2,c.sent()]}var a}))}))()},A.loginZaloV4=function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",c=this;return e((function(){var a,u;return g(this,(function(l){switch(l.label){case 0:return(a=new URLSearchParams).append("app_id",n),a.append("code",t),a.append("code_verifier",r),o.isNull(c.refreshToken)||0===c.refreshToken.length?a.append("grant_type","authorization_code"):(a.append("grant_type","refresh_token"),a.append("refresh_token",c.refreshToken||"")),u={headers:{"Content-Type":"application/x-www-form-urlencoded"}},[4,fetch(i.GET_ACCESS_TOKEN,s({method:"POST",body:a},u)).then((m=e((function(e){var n,t,s,o;return g(this,(function(r){switch(r.label){case 0:return[4,e.json()];case 1:return n=r.sent(),t=(null==n?void 0:n.access_token)||"",s=(null==n?void 0:n.refresh_token)||"",c.refreshToken=s,c._accessToken=t,o=1e3*parseInt(null==n?void 0:n.expires_in),c.accessTokenExpiresIn=o,c.prevGetAccessTokenTimestamp=(new Date).getTime(),window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(t),[2,t]}}))})),function(e){return m.apply(this,arguments)}))];case 1:return[2,l.sent()]}var m}))}))()},A.getAccessToken=function(){var n=this;return e((function(){var t,s,o,i,u,l,m;function p(){return h.apply(this,arguments)}function h(){return(h=e((function(){return g(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){var n=setInterval((function(){(s.getAccessTokenCount<=1||s._accessToken)&&(e("done"),clearInterval(n))}),200)}))];case 1:return[2,e.sent()]}}))}))).apply(this,arguments)}return g(this,(function(e){switch(e.label){case 0:return t=(new Date).getTime()-n.prevGetAccessTokenTimestamp,(s=n).getAccessTokenCount++,n.getAccessTokenCount>1?[4,p()]:[3,2];case 1:e.sent(),e.label=2;case 2:return n.manualSetAccessToken||n._accessToken.length>0&&t<n.accessTokenExpiresIn?(s.getAccessTokenCount--,[2,Promise.resolve(n._accessToken)]):(n.accessToken="",[4,n.jumpAndGetToken(r.ZOAUTH)]);case 3:return o=e.sent(),[4,n.jumpAndGetToken(r.ZOAUTH_VRF)];case 4:return i=e.sent(),u="zmp.getaccesstoken.fail",[4,n.verifyUserAuthorized()];case 5:if(!e.sent())throw s.getAccessTokenCount--,d([{action:u,error:-104,message:"no user auth",data:{}}]),f.error.loginFailed("User Authentication Required");if(!o)return[3,13];e.label=6;case 6:return e.trys.push([6,11,,12]),i?[4,n.loginZaloV4(c,o,i)]:[3,8];case 7:return l=e.sent(),[3,10];case 8:return[4,n.loginZaloV3(c,a,o)];case 9:l=e.sent(),e.label=10;case 10:return[3,12];case 11:return m=e.sent(),l="",console.log("Can not get access token",m),d([{action:u,error:-103,message:String(m)||"Can not get access token",data:{}}]),[3,12];case 12:return s.getAccessTokenCount--,l||d([{action:u,error:-101,message:"no accessToken",data:{}}]),[2,Promise.resolve(n._accessToken)];case 13:throw s.getAccessTokenCount--,d([{action:u,error:-102,message:"no oauth",data:{}}]),f.error.loginFailed("Zalo app has not been activated")}}))}))()},A.verifyUserAuthorized=function(){var n=this;return e((function(){var e,t,s,o,r,i;return g(this,(function(c){switch(c.label){case 0:if(t=!0,!1!==(null===(e=n._miniProgramConfig)||void 0===e?void 0:e.userAuthorized))return[3,6];c.label=1;case 1:return c.trys.push([1,5,,6]),(s=h("action.mp.user.authorize"))&&s.isSupported?[4,k()]:[3,4];case 2:return!1!==(null==(r=c.sent())||null===(o=r.authSetting)||void 0===o?void 0:o["scope.userInfo"])?[3,4]:[4,T()];case 3:i=c.sent(),t=(null==i?void 0:i["scope.userInfo"])||!1,c.label=4;case 4:return[3,6];case 5:return c.sent(),t=!1,[3,6];case 6:return[2,t]}}))}))()},A.setAccessToken=function(e){this.manualSetAccessToken=!0,this._accessToken=e,window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(e)},A.getJSAccessToken=function(){var n=this;return e((function(){var e;return g(this,(function(t){switch(t.label){case 0:return n._jsAccessToken.length>0?[2,Promise.resolve(n._jsAccessToken)]:[4,n.jumpAndGetToken(r.JS_TOKEN)];case 1:return e=t.sent(),[2,Promise.resolve(e)]}}))}))()},A.getSync=function(e){var n;return null===(n=this._cookies.find((function(n){return n.name===e})))||void 0===n?void 0:n.value},A.jumpAndGetToken=function(n){var t,s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this;return new Promise((t=e((function(e){var t,i,c,a;return g(this,(function(u){switch(u.label){case 0:return!s&&r._cookies.length>0?o.isString(n)?(t=r._cookies.find((function(e){return e.name===n})),[2,e(null==t?void 0:t.value)]):[2,e("")]:(s&&r._jumpStatus===_.DONE&&(r._jumpStatus=void 0),i={name:n,cb:function(n){return e(n)}},[4,r.jump()]);case 1:return(c=u.sent())===_.DONE?(r._jumpStatus=c,r.WAITING_QUEUE.length&&(r.WAITING_QUEUE.forEach((function(e){var n=r._cookies.find((function(n){return n.name===e.name}));e.cb(null==n?void 0:n.value)})),r.WAITING_QUEUE=[]),a=r._cookies.find((function(e){return e.name===i.name})),i.cb(null==a?void 0:a.value)):r.WAITING_QUEUE.push(i),[2]}}))})),function(e){return t.apply(this,arguments)}))},v.getInstance=function(){return v.instance||(v.instance=new v),v.instance},t(v,[{key:"jumpStatus",get:function(){return this._jumpStatus}},{key:"accessToken",set:function(e){this._accessToken=e,window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(e)}},{key:"miniProgramConfig",get:function(){return this._miniProgramConfig}}]),v}(),A=v.getInstance();export{A as default};
